<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy Birthday!</title>
    <link rel="icon" type="image/x-icon"
        href="https://icons.iconarchive.com/icons/google/noto-emoji-activities/256/52707-party-popper-icon.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&family=Sacramento&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ribeye&display=swap" rel="stylesheet">


    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #fce7f3;
            overflow-x: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            /* Use dynamic viewport height for better mobile fullscreen adjustment */
            height: 100vh;
            height: 100dvh;
            /* Add transition for smooth dimming effect */
            transition: background-color 1.5s ease-in-out;
        }

        /* --- Dim Background Mode --- */
        body.dim-background {
            background-color: #2b1621;
            /* Dark pinkish-brown (Cozy dark) */
        }

        /* Adjust text visibility in dim mode */
        body.dim-background h2 {
            color: #ffb7b2;
            text-shadow: 0 0 15px rgba(255, 100, 100, 0.5);
            transition: color 1s;
        }

        body.dim-background p#cake-instruction {
            color: #d1d5db;
            transition: color 1s;
        }

        body.dim-background #wish-text {
            color: #fff;
            text-shadow: 0 0 10px #ff69b4;
        }

        .title-font {
            font-family: 'Sacramento', cursive;
        }

        .font-family-Ribeye {
            font-family: 'Ribeye', cursive;
        }

        /* --- Transitions --- */
        .page {
            display: none;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            height: 100vh;
            height: 100dvh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .page.active {
            display: flex;
            opacity: 1;
            z-index: 10;
        }


        /* --- Numpad Heart Styles --- */
        .heart-btn {
            position: relative;
            background-color: #f472b6;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 65px;
            height: 65px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            aspect-ratio: 1 / 1;
            clip-path: path("M32.5 58C14 44 3 33 3 20.5 3 11 10 4 19.2 4c5.8 0 11 3 13.3 7.6C34.8 7 40 4 45.7 4 55 4 62 11 62 20.5 62 33 51 44 32.5 58z");
            box-shadow: 0 6px 0 #db2777, 0 10px 15px rgba(0, 0, 0, 0.25);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .heart-btn::after {
            content: "";
            position: absolute;
            inset: 0;
            clip-path: inherit;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.45), rgba(255, 255, 255, 0) 60%);
            pointer-events: none;
        }

        .heart-btn:active,
        .heart-btn.active-state {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #db2777, 0 6px 10px rgba(0, 0, 0, 0.25);
        }

        .heart-btn.span-2 {
            clip-path: none;
            border-radius: 32px;
            width: unset;
            height: unset;
            padding: 0.5rem 0;
        }


        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
            justify-items: center;
        }

        /* --- Cake CSS --- */
        :root {
            /* Updated Palette for Beautiful Cake */
            --cake-body: #5D4037;
            /* Dark Chocolate */
            --cake-shadow: #3E2723;
            --icing-main: #F48FB1;
            /* Strawberry Pink */
            --icing-light: #F8BBD0;
            --plate-color: #FFFFFF;
        }

        .food-coloring-chocolate {
            /* Gradient for 3D cylinder effect */
            background: linear-gradient(90deg, var(--cake-body) 0%, #8D6E63 50%, var(--cake-body) 100%);
            box-shadow:
                0 2px 0px var(--cake-shadow),
                0 4px 0px var(--cake-shadow),
                0 6px 0px var(--cake-shadow),
                0 8px 0px var(--cake-shadow),
                0 10px 0px var(--cake-shadow),
                0 12px 0px var(--cake-shadow),
                0 14px 0px var(--cake-shadow),
                0 16px 0px var(--cake-shadow),
                0 18px 0px var(--cake-shadow),
                0 20px 0px var(--cake-shadow),
                0 22px 0px var(--cake-shadow),
                0 24px 0px var(--cake-shadow),
                0 26px 0px var(--cake-shadow),
                0 28px 0px var(--cake-shadow),
                0 30px 0px var(--cake-shadow);
        }

        .cake-container {
            position: relative;
            width: 270px;
            height: 250px;
            cursor: pointer;
            margin-top: -20px;
            /* Pull slightly up overall */
        }

        .cake-container .cake {
            position: absolute;
            width: 250px;
            height: 200px;
            /* CHANGED: Moved from 80% to 58% to lift the cake up */
            top: 60%;
            left: 50%;
            transform-style: preserve-3d;
            transform: translate(-50%, -50%) rotateX(20deg) scale(0.9);
        }

        .plate {
            width: 270px;
            height: 110px;
            position: absolute;
            bottom: -10px;
            left: -10px;
            background-color: var(--plate-color);
            border-radius: 50%;
            /* Realistic Plate Shadow & Rim */
            box-shadow:
                0 4px 0 #E0E0E0,
                0 6px 0 #BDBDBD,
                0 10px 40px rgba(0, 0, 0, 0.3),
                inset 0 0 0 5px rgba(0, 0, 0, 0.05);
            transform: translateZ(-20px) rotateX(-20deg);
            z-index: 0;
        }

        .cake>* {
            position: absolute;
        }

        .layer {
            position: absolute;
            display: block;
            width: 250px;
            height: 100px;
            border-radius: 50%;
        }

        .layer-top {
            top: 0px;
            transform: translateZ(60px);
        }

        .layer-middle {
            top: 33px;
            transform: translateZ(30px);
        }

        .layer-bottom {
            top: 66px;
            transform: translateZ(0px);
        }

        .icing {
            top: 2px;
            left: 5px;
            background-color: var(--icing-main);
            width: 240px;
            height: 90px;
            border-radius: 50%;
            transform: translateZ(65px);
            z-index: 2;
            /* Sprinkles Pattern */
            background-image:
                radial-gradient(circle, #FFEB3B 2px, transparent 2.5px),
                radial-gradient(circle, #4FC3F7 2px, transparent 2.5px),
                radial-gradient(circle, #69F0AE 2px, transparent 2.5px),
                radial-gradient(circle, #FFFFFF 2px, transparent 2.5px);
            background-size: 40px 40px, 50px 50px, 30px 60px, 20px 20px;
            background-position: 0 0, 20px 10px, 10px 20px, 5px 5px;
        }

        .icing::before {
            content: "";
            position: absolute;
            top: 4px;
            right: 5px;
            bottom: 6px;
            left: 5px;
            background-color: var(--icing-light);
            /* Soft highlight */
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            z-index: 1;
        }

        .drip {
            display: block;
            width: 50px;
            height: 60px;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            background-color: var(--icing-main);
            transform: translateZ(60px);
            z-index: 3;
            /* Add shadow to drips for realism */
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .drip1 {
            top: 53px;
            left: 5px;
            transform: skewY(15deg) translateZ(60px);
            height: 48px;
            width: 40px;
        }

        .drip2 {
            top: 69px;
            left: 181px;
            transform: skewY(-15deg) translateZ(60px);
        }

        .drip3 {
            top: 54px;
            left: 90px;
            width: 80px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            transform: translateZ(60px);
        }

        .candle {
            background: repeating-linear-gradient(45deg,
                    var(--c1, #ff9a9e),
                    var(--c1, #ff9a9e) 5px,
                    var(--c2, #fecfef) 5px,
                    var(--c2, #fecfef) 10px);
            width: 16px;
            height: 50px;
            border-radius: 8px / 4px;
            top: -20px;
            left: 50%;
            margin-left: -8px;
            z-index: 10;
            position: absolute;
            transform-origin: bottom center;
            box-shadow: inset -2px 0 2px rgba(0, 0, 0, 0.1);
        }

        .candle::before {
            content: "";
            position: absolute;
            top: -2px;
            left: 7px;
            width: 2px;
            height: 6px;
            border-radius: 0;
            background-color: #333;
            filter: none;
        }

        /* --- UPDATED FLAME (More Realistic & 3D) --- */
        .flame {
            position: absolute;
            /* Gradient for 3D hot core look */
            background: radial-gradient(ellipse at bottom, #ffffd1 0%, #fff700 30%, #ff8800 60%, #ff4500 100%);
            width: 14px;
            height: 34px;
            border-radius: 100% 100% 60% 60% / 100% 100% 30% 30%;
            top: -36px;
            left: 50%;
            margin-left: -7px;
            z-index: 10;
            /* Intense glow */
            box-shadow:
                0 0 10px 2px rgba(255, 220, 0, 0.5),
                0 0 20px 5px rgba(255, 100, 0, 0.3),
                0 0 40px 10px rgba(255, 50, 0, 0.1);
            transform-origin: 50% 90%;
            animation: flicker 1s ease-in-out alternate infinite;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        @keyframes flicker {
            0% {
                transform: skewX(2deg) scaleY(1);
                box-shadow:
                    0 0 10px 2px rgba(255, 220, 0, 0.5),
                    0 0 20px 5px rgba(255, 100, 0, 0.3);
                opacity: 1;
            }

            25% {
                transform: skewX(-2deg) scaleY(1.05);
                box-shadow:
                    0 0 12px 3px rgba(255, 220, 0, 0.6),
                    0 0 25px 6px rgba(255, 100, 0, 0.4);
                opacity: 0.95;
            }

            50% {
                transform: skewX(3deg) scaleY(0.95);
                box-shadow:
                    0 0 9px 2px rgba(255, 220, 0, 0.5),
                    0 0 18px 4px rgba(255, 100, 0, 0.3);
                opacity: 1;
            }

            75% {
                transform: skewX(-1deg) scaleY(1.02);
                box-shadow:
                    0 0 13px 3px rgba(255, 220, 0, 0.6),
                    0 0 22px 5px rgba(255, 100, 0, 0.4);
                opacity: 0.9;
            }

            100% {
                transform: skewX(2deg) scaleY(1);
                box-shadow:
                    0 0 10px 2px rgba(255, 220, 0, 0.5),
                    0 0 20px 5px rgba(255, 100, 0, 0.3);
                opacity: 1;
            }
        }

        .smoke {
            position: absolute;
            width: 6px;
            height: 10px;
            background: rgba(200, 200, 200, 0.6);
            top: -15px;
            left: 50%;
            margin-left: -3px;
            border-radius: 50%;
            animation: smoke-rise 2.5s ease-out forwards;
            z-index: 9;
            pointer-events: none;
        }

        @keyframes smoke-rise {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.6;
            }

            30% {
                opacity: 0.4;
            }

            100% {
                transform: translateY(-50px) scale(4);
                opacity: 0;
            }
        }

        /* --- NEW Cartoon Blowing Character (Cuter Bear) --- */
        #cartoon-blower {
            position: fixed;
            bottom: -400px;
            /* Start hidden deeper */
            left: 50%;
            transform: translateX(-50%);
            width: 320px;
            height: auto;
            z-index: 50;
            transition: bottom 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Bouncy entrance */
            pointer-events: none;
        }

        #cartoon-blower.active {
            bottom: -20px;
        }

        /* -- Bear SVG Styles -- */
        .bear-body {
            transform-origin: center bottom;
            transition: transform 0.4s ease-out;
        }

        /* Eyes */
        .bear-eye {
            transform-origin: center;
            transition: transform 0.1s, opacity 0.1s;
        }

        .bear-eye-closed {
            opacity: 0;
            transform: scaleY(0);
        }

        /* Cheeks */
        .bear-cheek {
            opacity: 0.4;
            transform: scale(1);
            transform-origin: center;
            transition: all 0.3s ease;
        }

        /* Mouth */
        .bear-mouth-happy {
            opacity: 1;
            transition: opacity 0.1s;
        }

        .bear-mouth-blow {
            opacity: 0;
            transform: scale(0.5);
            transform-origin: center;
            transition: opacity 0.1s, transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Arms */
        .bear-arm {
            transform-origin: 80px 250px;
            /* Approximate pivot */
            transition: transform 0.5s ease;
        }

        .bear-arm.right {
            transform-origin: 240px 250px;
        }

        /* Wind */
        .wind-group {
            opacity: 0;
            transform-origin: center bottom;
        }

        .wind-line {
            stroke: rgba(255, 255, 255, 0.7);
            stroke-width: 5;
            stroke-linecap: round;
            fill: none;
            stroke-dasharray: 80;
            stroke-dashoffset: 80;
        }

        /* --- ANIMATION STATES --- */

        /* 1. INHALE (Prepare) */
        .inhaling .bear-body {
            transform: translateY(20px) scale(1.05);
            /* Lean back/Inhale */
        }

        .inhaling .bear-cheek {
            opacity: 0.8;
            fill: #ff5252;
            /* Redder cheeks */
            transform: scale(1.5);
            /* Big cheeks */
        }

        .inhaling .bear-eye {
            opacity: 0;
            /* Hide open eyes */
        }

        .inhaling .bear-eye-closed {
            opacity: 1;
            /* Show closed >_< eyes */
            transform: scaleY(1);
        }

        .inhaling .bear-mouth-happy {
            opacity: 0;
        }

        .inhaling .bear-mouth-blow {
            opacity: 1;
            transform: scale(0.5);
            /* Closed puckered mouth holding breath */
        }

        .inhaling .bear-arm {
            transform: rotate(-10deg) translateY(10px);
        }

        .inhaling .bear-arm.right {
            transform: rotate(10deg) translateY(10px);
        }

        /* 2. BLOW (Action) */
        .blowing .bear-body {
            transform: translateY(-15px) scale(0.98);
            /* Lean forward */
        }

        .blowing .bear-cheek {
            opacity: 0.3;
            transform: scale(0.8);
            /* Cheeks collapse */
        }

        .blowing .bear-eye {
            opacity: 1;
        }

        /* Eyes open wide */
        .blowing .bear-eye-closed {
            opacity: 0;
        }

        .blowing .bear-mouth-happy {
            opacity: 0;
        }

        .blowing .bear-mouth-blow {
            opacity: 1;
            transform: scale(1.0);
            /* Tight small pucker, NOT wide open */
        }

        /* Wind Animation Trigger */
        .blowing .wind-group {
            opacity: 1;
        }

        .blowing .wind-line {
            animation: strongWind 0.4s ease-out forwards;
        }

        @keyframes strongWind {
            0% {
                stroke-dashoffset: 80;
                transform: translateY(20px) scale(0.5);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            100% {
                stroke-dashoffset: -100;
                transform: translateY(-200px) scale(1.2);
                opacity: 0;
            }
        }


        /* --- Puzzle Styles --- */
        .puzzle-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            width: 315px;
            height: 315px;
            margin: 0 auto;
            border: 5px solid #fff;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            background: #eee;
            touch-action: none;
            transition: gap 0.5s ease;
        }

        .puzzle-piece {
            width: 100%;
            height: 100px;
            background-size: 300px 300px;
            cursor: grab;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0s ease-out, opacity 0.1s, border 0.5s ease;
        }

        .puzzle-piece.dragging {
            opacity: 0.8;
            border: 2px solid #db2777;
            z-index: 50;
        }

        .puzzle-piece.over {
            border: 2px dashed #db2777;
        }

        /* --- Envelope & Card --- */
        .envelope-wrapper {
            position: relative;
            cursor: pointer;
            height: 340px;
            width: 320px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 120px;
            perspective: 1000px;
        }

        .envelope {
            width: 300px;
            height: 240px;
            position: relative;
            transform-style: preserve-3d;
        }

        .envelope-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #cf5959 0%, #c44343 100%);
            border-radius: 3px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            z-index: 0;
        }

        .envelope-left {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 0;
            border-bottom: 240px solid #fc7777;
            border-right: 300px solid transparent;
            z-index: 2;
            filter: brightness(0.75);
        }

        .envelope-right {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 0;
            height: 0;
            border-bottom: 240px solid #d35656;
            border-left: 300px solid transparent;
            z-index: 3;
            filter: brightness(0.95);
        }

        .envelope-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 140px;
            background: linear-gradient(to bottom, #ec7979, #e26262);
            clip-path: polygon(0 100%, 50% 0, 100% 100%);
            z-index: 4;
        }

        .envelope-flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 140px;
            background: linear-gradient(to bottom, rgb(206, 67, 67) 0%, #dd5555 50%, #dd6565 100%);
            clip-path: polygon(0 0, 50% 100%, 100% 0);
            transform-origin: 50% 0%;
            transition: transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 3px 3px 0 0;
        }

        .envelope-flap::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%, rgba(0, 0, 0, 0.1) 100%);
            clip-path: polygon(0 0, 50% 100%, 100% 0);
            z-index: 1;
        }

        .card {
            position: absolute;
            width: 270px;
            height: 220px;
            background: linear-gradient(to bottom, #ffffff 0%, #fef3f4 100%);
            left: 15px;
            bottom: 20px;
            padding: 25px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            z-index: 2;
            /* REMOVED: transition property here, handled by animation on .open */
            transform: translateY(10px);
            border: 1px solid #fecdd3;
        }

        .card::before {
            content: 'üíå';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            opacity: 0.3;
        }

        .envelope.open .envelope-flap {
            position: absolute;
            transform: rotateX(-180deg);
            animation: flapZIndex 0s 0.2s forwards;
        }

        @keyframes flapZIndex {
            to {
                z-index: 1;
            }
        }

        /* --- UPDATED CARD ANIMATION --- */

        /* Keyframes for Desktop/Standard: Slide Up -> Pop Forward -> Zoom Center */
        @keyframes cardPop {
            0% {
                transform: translateY(10px) scale(1) translateZ(0);
                z-index: 2;
            }

            40% {
                /* Step 1: Slide ALL the way up to clear the envelope pocket */
                transform: translateY(-220px) scale(1) translateZ(0);
                z-index: 2;
            }

            50% {
                /* Step 1.5: Switch Z-index to be visually in front */
                z-index: 20;
            }

            100% {
                /* Step 2: Move down slightly to center, Zoom In, and translateZ to pop 3D */
                /* translateY value adjusts the vertical center position relative to envelope */
                transform: translateY(-140px) scale(1.3) translateZ(100px);
                z-index: 20;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
                /* Stronger shadow */
            }
        }

        /* Keyframes for Mobile: Less Zoom to prevent overflow */
        @keyframes cardPopMobile {
            0% {
                transform: translateY(10px) scale(1) translateZ(0);
                z-index: 2;
            }

            40% {
                transform: translateY(-220px) scale(1) translateZ(0);
                z-index: 2;
            }

            50% {
                z-index: 20;
            }

            100% {
                /* Mobile: Scale only 1.1x to fit width */
                transform: translateY(-140px) scale(1.1) translateZ(100px);
                z-index: 20;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            }
        }

        .envelope.open .card {
            /* Apply animation when open */
            animation: cardPop 1.5s cubic-bezier(0.5, 0, 0.5, 1) 0.8s forwards;
        }

        /* Responsive override for small screens */
        @media (max-width: 480px) {
            .envelope.open .card {
                animation: cardPopMobile 1.5s cubic-bezier(0.5, 0, 0.5, 1) 0.8s forwards;
            }
        }
    </style>
</head>

<body>

    <div id="app" class="w-full min-h-screen flex flex-col items-center justify-center p-6 pt-6">

        <!-- Page 1: Landing Page -->
        <div id="page-1" class="page active flex-col items-center justify-center text-center">
            <h1 class="font-family-Ribeye text-6xl text-pink-600 mb-4 animate-pulse leading-normal">Happy Birthday!</h1>
            <p class="text-xl text-gray-500 mb-8">‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡∏î‡∏π‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?</p>
            <button id="startButton" onclick="goToPage(2)"
                class="px-8 py-3 bg-pink-500 text-white text-lg font-semibold rounded-xl shadow-lg hover:bg-pink-600 transition duration-300 transform hover:scale-105">
                ‡πÑ‡∏õ‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡πâ‡∏¢‡∏¢‡∏¢ <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>

        <!-- 2. LOGIN -->
        <div id="page-2" class="page flex-col justify-center items-center bg-pink-50 px-4">
            <div class="bg-white px-6 py-4 rounded-2xl shadow-xl text-center max-w-sm w-full mx-4">
                <div class="text-4xl mb-4">üîí</div>
                <h1 class="text-2xl font-bold text-pink-600 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞</h1>
                <p class="text-gray-500 mb-6">‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ô‡πä‡∏≤‡∏≤‡∏≤</p>

                <div id="birthdate-display"
                    class="w-full h-12 p-3 border-2 border-pink-500 bg-pink-100 rounded-lg mb-6 text-center text-3xl font-mono tracking-widest text-pink-700 flex items-center justify-center shadow-inner">
                    DD/MM
                </div>

                <div id="numpad" class="numpad-grid mx-auto">
                    <div class="heart-btn" data-value="1">1</div>
                    <div class="heart-btn" data-value="2">2</div>
                    <div class="heart-btn" data-value="3">3</div>
                    <div class="heart-btn" data-value="4">4</div>
                    <div class="heart-btn" data-value="5">5</div>
                    <div class="heart-btn" data-value="6">6</div>
                    <div class="heart-btn" data-value="7">7</div>
                    <div class="heart-btn" data-value="8">8</div>
                    <div class="heart-btn" data-value="9">9</div>
                    <div class="heart-btn bg-red-400 hover:bg-red-500 shadow-red-700 text-lg" data-action="clear">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <div class="heart-btn" data-value="0">0</div>
                    <div class="heart-btn bg-pink-400 hover:bg-pink-500 shadow-pink-700 text-lg"
                        data-action="backspace">
                        <i class="fas fa-backspace"></i>
                    </div>
                </div>

                <button onclick="checkBirthday()"
                    class="mt-6 w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 transition duration-300 transform hover:scale-105">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô <i class="fas fa-heart ml-2"></i>
                </button>
                <p id="error-msg" class="text-red-500 mt-2 hidden text-sm">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞!</p>
            </div>
        </div>

        <!-- 3. CAKE PAGE -->
        <div id="page-3" class="page flex-col justify-center items-center relative overflow-hidden">
            <h2 class="text-3xl font-bold text-pink-600 mb-6 title-font animate-bounce">Happy Birthday!</h2>
            <p id="cake-instruction" class="text-gray-600 mb-[70px]">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡πâ‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡πÄ‡∏•‡πà‡∏°‡∏ô‡∏∞!</p>

            <div class="cake-container" onclick="placeCandle(event)">
                <div class="cake" id="new-cake">
                    <div class="plate"></div>
                    <div class="layer layer-bottom food-coloring-chocolate"></div>
                    <div class="layer layer-middle food-coloring-chocolate"></div>
                    <div class="layer layer-top food-coloring-chocolate"></div>
                    <div class="icing" id="cake-surface"></div>
                    <div class="drip drip1"></div>
                    <div class="drip drip2"></div>
                    <div class="drip drip3"></div>
                </div>
            </div>

            <!-- Changed mt-20 to mt-8 to bring buttons closer -->
            <div id="wish-message" class="mt-8 text-center opacity-0 transition-opacity duration-1000 z-10">
                <p id="wish-text" class="text-2xl text-pink-700 font-bold mb-4">‚ú® ‡∏´‡∏•‡∏±‡∏ö‡∏ï‡∏≤‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡πÄ‡∏•‡∏¢! ‚ú®</p>

                <button id="confirm-wish-btn" onclick="finishWishing()"
                    class="bg-pink-500 text-white px-6 py-2 rounded-full hover:bg-pink-600 transition shadow-md">
                    ‡∏≠‡∏ò‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß <i class="fas fa-check"></i>
                </button>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà -->
                <button id="blow-btn" onclick="triggerCartoonBlow()"
                    class="hidden bg-blue-400 text-white px-8 py-3 rounded-full hover:bg-blue-500 transition shadow-lg animate-pulse text-xl font-bold border-4 border-white">
                    ‡πÄ‡∏õ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏¢! üå¨Ô∏è
                </button>

                <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡πà‡∏≠‡∏¢ -->
                <div id="blow-instruction" class="hidden mt-2">
                    <p class="text-xs text-gray-400">(‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏ß‡πÑ‡∏ü‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏°)</p>
                </div>

                <button id="next-to-gallery-btn" onclick="goToPage(4)"
                    class="hidden mt-4 bg-white border-2 border-pink-500 text-pink-500 px-6 py-2 rounded-full hover:bg-pink-500 hover:text-white transition shadow-md">
                    ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢ <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <!-- Cartoon Overlay for "Fake" Blowing (NEW CUTE BEAR) -->
            <div id="cartoon-blower">
                <svg viewBox="0 0 320 320" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <!-- Gradient for soft fur look -->
                        <radialGradient id="bearFur" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                            <stop offset="0%" style="stop-color:#d29054;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8d5524;stop-opacity:1" />
                        </radialGradient>
                    </defs>

                    <g class="bear-body">
                        <!-- Ears -->
                        <circle cx="80" cy="100" r="35" fill="#8d5524" />
                        <circle cx="240" cy="100" r="35" fill="#8d5524" />
                        <circle cx="80" cy="100" r="20" fill="#f4c698" />
                        <circle cx="240" cy="100" r="20" fill="#f4c698" />

                        <!-- Head -->
                        <ellipse cx="160" cy="170" rx="110" ry="100" fill="url(#bearFur)" />

                        <!-- Paws/Arms (Peeking up) -->
                        <ellipse class="bear-arm" cx="60" cy="280" rx="30" ry="40" fill="#8d5524" />
                        <ellipse class="bear-arm right" cx="260" cy="280" rx="30" ry="40" fill="#8d5524" />

                        <!-- Snout -->
                        <ellipse cx="160" cy="190" rx="50" ry="40" fill="#f4c698" stroke="#d29054" stroke-width="2" />

                        <!-- Nose -->
                        <path d="M 145 175 Q 160 165 175 175 Q 160 195 145 175" fill="#3e2723" />

                        <!-- Normal Eyes -->
                        <g class="bear-eye">
                            <circle cx="120" cy="150" r="10" fill="#3e2723" />
                            <circle cx="123" cy="147" r="3" fill="#fff" />
                            <circle cx="200" cy="150" r="10" fill="#3e2723" />
                            <circle cx="203" cy="147" r="3" fill="#fff" />
                        </g>

                        <!-- Closed Eyes (For Inhaling) -->
                        <g class="bear-eye-closed">
                            <path d="M 110 150 L 120 155 L 130 150" stroke="#3e2723" stroke-width="4" fill="none"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M 190 150 L 200 155 L 210 150" stroke="#3e2723" stroke-width="4" fill="none"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </g>

                        <!-- Cheeks (Big when inhaling) -->
                        <circle class="bear-cheek" cx="90" cy="180" r="20" fill="#ff8a80" />
                        <circle class="bear-cheek" cx="230" cy="180" r="20" fill="#ff8a80" />

                        <!-- Mouth: Happy (Default) -->
                        <path class="bear-mouth-happy" d="M 150 205 Q 160 215 170 205" stroke="#3e2723" stroke-width="4"
                            fill="none" stroke-linecap="round" />

                        <!-- Mouth: Pucker (For blowing) -->
                        <g class="bear-mouth-blow">
                            <circle cx="160" cy="205" r="6" fill="#3e2723" stroke="#000" stroke-width="2" />
                            <circle cx="160" cy="205" r="2" fill="#000" />
                        </g>
                    </g>

                    <!-- Strong Wind Lines -->
                    <g class="wind-group" transform="translate(160, 200)">
                        <path class="wind-line" d="M 0 0 L 0 -150" />
                        <path class="wind-line" d="M -15 10 L -60 -120" style="animation-delay: 0.05s;" />
                        <path class="wind-line" d="M 15 10 L 60 -120" style="animation-delay: 0.1s;" />
                    </g>
                </svg>
            </div>
        </div>

        <!-- 4. GALLERY -->
        <div id="page-4" class="page flex-col justify-start items-center pt-10 pb-32 overflow-y-auto">
            <h2 class="text-3xl text-pink-600 font-bold mb-6 title-font">Our Memories</h2>
            <div id="gallery-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 px-6 pb-10 w-full max-w-2xl">
                <!-- Gallery items will be injected here -->
            </div>
            <button onclick="goToPage(5)"
                class="mb-10 bg-pink-500 text-white px-8 py-3 rounded-full shadow-lg hover:bg-pink-600 animate-pulse">
                ‡πÑ‡∏õ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Å‡∏±‡∏ô‡πÄ‡∏ñ‡∏≠‡∏∞ <i class="fas fa-gamepad ml-2"></i>
            </button>
        </div>

        <!-- 5. PUZZLE -->
        <div id="page-5" class="page flex-col justify-center items-center">
            <h2 class="text-2xl text-pink-600 font-bold mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞</h2>
            <p class="text-sm text-gray-500 mb-6">‡∏•‡∏≤‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô (Drag & Drop)</p>
            <div class="puzzle-container" id="puzzle-board"></div>
            <p id="puzzle-success" class="text-green-500 font-bold mt-4 hidden text-xl">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! üéâ</p>
            <button id="next-to-card-btn" onclick="goToPage(6)"
                class="mt-6 bg-pink-500 text-white px-6 py-2 rounded-full opacity-50 cursor-not-allowed pointer-events-none transition">
                ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ <i class="fas fa-gift ml-2"></i>
            </button>
        </div>

        <!-- 6. CARD PAGE -->
        <div id="page-6" class="page flex-col justify-center items-center bg-pink-100">
            <h2 class="text-[40px] text-pink-600 font-bold mb-[50px] title-font">For You...</h2>

            <div class="envelope-wrapper mt-[100px]" onclick="openEnvelope()">
                <div class="envelope" id="envelope">
                    <div class="envelope-back"></div>
                    <div class="card">
                        <h3 class="text-[16px] font-bold text-pink-600 mt-2">‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ô‡∏∞ ‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á</h3>
                        <p class="text-gray-600 text-[12px] mt-2 leading-relaxed">
                            ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ò‡∏≠‡πÇ‡∏ï‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏µ‡∏Å‡∏õ‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞<br>
                            ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡πÜ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠<br>
                            ‡πÄ‡∏ï‡πá‡∏°‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏¢‡∏¢‡∏¥‡πâ‡∏°<br>
                            ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏à‡∏≠‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£ ‡∏Å‡πá‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏î‡∏µ<br>
                            ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ‡∏ß‡∏±‡∏ô<br>
                            ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î ‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏ô<br>
                            ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ò‡∏≠‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏ô‡∏∞<br>

                        </p>
                        <div class="mt-2 text-[14px]">üç∞üéÅüéà</div>
                    </div>
                    <div class="envelope-left"></div>
                    <div class="envelope-right"></div>
                    <div class="envelope-bottom"></div>
                    <div class="envelope-flap"></div>
                </div>
            </div>
            <p id="tapEnvelope" class="-mt-6 text-gray-500 animate-pulse">‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ã‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î</p>
        </div>
    </div>

    <!-- Main Background Music (Happy/Upbeat) -->
    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/audio/2025/04/04/audio_2c2635b316.mp3" type="audio/mpeg">
    </audio>

    <!-- Romantic/Acoustic Music (For Gallery onwards) -->
    <audio id="bg-music-romantic" loop>
        <source src="https://cdn.pixabay.com/audio/2025/06/10/audio_581485d4c9.mp3" type="audio/mpeg">
    </audio>

    <script>
        const TARGET_BIRTHDAY_MD = "04/12";
        const PUZZLE_IMAGE = "https://raw.githubusercontent.com/npss-93/birthday/main/images/puzzle.jpg";
        let currentCandles = 0;
        const totalCandles = 5;
        let candlesExtinguished = 0;
        let isBlowingMode = false;

        // Music State
        let currentAudioId = 'bg-music'; // Tracks which audio should be playing
        let isPlayingManually = false;

        let puzzleArr = [0, 1, 2, 3, 4, 5, 6, 7, 8];
        let dragSrcEl = null;
        let touchStartPiece = null;
        let touchSrc = null;
        let currentTouchTarget = null;
        let birthdateInput = "";

        const gallery = [
            {
                title: '‡πÄ‡∏î‡∏ó‡πÅ‡∏£‡∏Å',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/FirstDate.jpg'
            },
            {
                title: '‡πÄ‡∏Ç‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏°',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/KhaoChongLom.jpg'
            },
            {
                title: '‡∏ó‡∏∞‡πÄ‡∏•',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/Sea.jpg'
            },
            {
                title: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≤‡∏ô',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/ChiangKhan.jpg'
            },
            {
                title: '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/ChiangMai.jpg'
            },
            {
                title: '‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/MaeHongSon.jpg'
            },
            {
                title: '‡πÄ‡∏Ç‡∏≤‡πÉ‡∏´‡∏ç‡πà',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/KhaoYai.jpg'
            },
            {
                title: '‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏µ‡∏ï‡πà‡∏≠‡∏á',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/Ban_E_Tong.jpg'
            },
            {
                title: '‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏°‡∏≠‡∏ç',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/MonBridge.jpg'
            },
            {
                title: '‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/Cafe.jpg'
            },
            {
                title: '‡πÅ‡∏Ñ‡∏°‡∏õ‡πå‡∏õ‡∏¥‡πâ‡∏á',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/Camping.jpg'
            },
            {
                title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ï‡πà‡∏≠‡πÜ‡πÑ‡∏õ',
                image: 'https://raw.githubusercontent.com/npss-93/birthday/main/images/Continue.jpg'
            }
        ];

        // --- Audio Context for Haptic Click ---
        let audioCtx;
        function initAudioCtx() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            renderGallery();
            setupNumpad();
            updateBirthdateDisplay();
        });

        // --- UPDATED: Haptic Feedback Utility (Crisp Click) ---
        function haptic(pattern) {
            // Removed visual shake animation

            // 1. Audio Click (Simulate Taptic Engine)
            playHapticClick();

            // 2. Native Vibrate (Android)
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        function playHapticClick() {
            // Initialize context on first interaction if needed
            initAudioCtx();
            if (!audioCtx) return;

            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            // UPDATED: Loud and Clear Click
            osc.type = 'sine';
            osc.frequency.setValueAtTime(200, t); // Higher pitch for clarity (was 150)
            osc.frequency.exponentialRampToValueAtTime(120, t + 0.05);

            // Harder Attack, Louder Gain
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(1.0, t + 0.005); // Max volume 1.0 (was 0.8)
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.08); // Longer tail (was 0.04)

            osc.start(t);
            osc.stop(t + 0.09);
        }

        // --- NEW: Wind Sound Effect Generator ---
        function playWindSound() {
            initAudioCtx();
            if (!audioCtx) return;
            const t = audioCtx.currentTime;

            // Generate Noise Buffer (2 seconds)
            const bufferSize = audioCtx.sampleRate * 2;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            // Lowpass filter to shape noise into "Wind"
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(100, t);
            filter.frequency.exponentialRampToValueAtTime(800, t + 0.5); // Whoosh up
            filter.frequency.exponentialRampToValueAtTime(100, t + 1.5); // Whoosh down

            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, t);
            // INCREASED GAIN for louder wind
            gain.gain.linearRampToValueAtTime(1.0, t + 0.2); // Fade in to 1.0 (was 0.5)
            gain.gain.linearRampToValueAtTime(0, t + 1.5); // Fade out

            noise.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            noise.start(t);
        }

        // --- Numpad Logic ---
        function setupNumpad() {
            document.querySelectorAll('.heart-btn').forEach(button => {
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    button.classList.add('active-state');
                    haptic(5); // Ultra short vibrate for tap
                    handleNumpadInput(button);
                }, { passive: false });

                button.addEventListener('touchend', (e) => {
                    setTimeout(() => button.classList.remove('active-state'), 100);
                });

                button.addEventListener('click', () => {
                    initAudioCtx();
                    handleNumpadInput(button);
                });
            });
        }

        function handleNumpadInput(button) {
            const value = button.dataset.value;
            const action = button.dataset.action;
            const err = document.getElementById('error-msg');
            err.classList.add('hidden');

            if (value) {
                if (birthdateInput.length < 5) {
                    if (birthdateInput.length === 2) {
                        birthdateInput += '/';
                    }
                    if (birthdateInput.length < 5) {
                        birthdateInput += value;
                    }
                }
            } else if (action === 'backspace') {
                if (birthdateInput.length > 0) {
                    birthdateInput = birthdateInput.slice(0, -1);
                }
                if (birthdateInput.endsWith('/')) {
                    birthdateInput = birthdateInput.slice(0, -1);
                }
            } else if (action === 'clear') {
                birthdateInput = "";
            }

            updateBirthdateDisplay();
        }

        function updateBirthdateDisplay() {
            const display = document.getElementById('birthdate-display');
            let rawInput = birthdateInput;

            if (rawInput.length === 0) {
                display.textContent = 'DD/MM';
                display.classList.add('text-gray-400');
                return;
            } else {
                display.classList.remove('text-gray-400');
            }

            let formattedDisplay = rawInput.replace(/[0-9]/g, '*');

            if (formattedDisplay.length < 5) {
                if (formattedDisplay.length >= 2 && !formattedDisplay.includes('/')) {
                    formattedDisplay += '/';
                }
                formattedDisplay = formattedDisplay.padEnd(5, '_');
            }
            display.textContent = formattedDisplay;
        }

        function renderGallery() {
            const container = document.getElementById('gallery-grid');
            if (!container) return;

            container.innerHTML = '';
            const rotations = ['rotate-2', '-rotate-2', 'rotate-1', '-rotate-1'];

            gallery.forEach((item, index) => {
                if (!item.image) return;

                const rotateClass = rotations[index % rotations.length];
                const cardHTML = `
                <div class="bg-white p-4 rounded-xl shadow-lg transform ${rotateClass} hover:rotate-0 transition duration-300 flex flex-col items-center">
                    <div class="w-full aspect-[3/4] overflow-hidden rounded-lg mb-3 bg-gray-100">
                        <img src="${item.image}" onerror="this.onerror=null; this.src='https://placehold.co/300x400/f06292/ffffff?text=Memory';" class="w-full h-full object-cover">
                    </div>
                    <p class="text-center text-pink-600 font-medium text-sm md:text-base">${item.title}</p>
                </div>
                `;
                container.innerHTML += cardHTML;
            });
        }

        function pauseMusic() {
            // Pause ONLY the currently active music
            const audio = document.getElementById(currentAudioId);
            if (audio && !audio.paused) {
                audio.pause();
            }
        }

        function playMusic() {
            // Play whichever is set as current
            const audio = document.getElementById(currentAudioId);

            // Ensure proper volume
            if (currentAudioId === 'bg-music-romantic') {
                audio.volume = 0.2; // Slightly louder for emotional acoustic
            } else {
                audio.volume = 0.1;
            }

            if (audio.paused) {
                audio.play().then(() => {
                    isPlayingManually = true;
                }).catch(e => {
                    console.error("Audio autoplay blocked or user interaction required:", e);
                });
            } else {
                isPlayingManually = true;
            }
        }

        // --- NEW: Crossfade Logic ---
        function switchMusicToRomantic() {
            if (currentAudioId === 'bg-music-romantic') return; // Already playing

            const oldAudio = document.getElementById('bg-music');
            const newAudio = document.getElementById('bg-music-romantic');

            // 1. Prepare new audio
            newAudio.currentTime = 0;
            newAudio.volume = 0;
            newAudio.play().catch(e => console.log("New audio play error", e));

            // 2. Crossfade Loop
            const maxVol = 0.2; // Target volume for romantic song
            let volOld = oldAudio.volume;
            let volNew = 0;

            const fadeInterval = setInterval(() => {
                // Fade Out Old
                if (volOld > 0) {
                    volOld = Math.max(0, volOld - 0.005); // Slow fade
                    oldAudio.volume = volOld;
                }

                // Fade In New
                if (volNew < maxVol) {
                    volNew = Math.min(maxVol, volNew + 0.005);
                    newAudio.volume = volNew;
                }

                // Stop when done
                if (volOld === 0 && volNew >= maxVol) {
                    clearInterval(fadeInterval);
                    oldAudio.pause();
                    currentAudioId = 'bg-music-romantic'; // Update global state
                }
            }, 50); // Update every 50ms
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                pauseMusic();
            } else {
                if (isPlayingManually) {
                    playMusic();
                }
            }
        });

        window.addEventListener('blur', pauseMusic);
        window.addEventListener('focus', () => {
            if (isPlayingManually) {
                playMusic();
            }
        });
        window.addEventListener('pagehide', pauseMusic);

        function goToPage(pageJson) {
            // Init audio context on navigation actions
            initAudioCtx();
            haptic(15);

            // --- Logic for Music Switch ---
            if (pageJson === 4) {
                // Switching to Gallery -> Change to Romantic Music
                switchMusicToRomantic();
            }

            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                setTimeout(() => { if (!p.classList.contains('active')) p.style.display = 'none'; }, 1000);
            });
            const target = document.getElementById(`page-${pageJson}`);
            target.style.display = 'flex';
            setTimeout(() => { target.classList.add('active'); }, 50);
            if (pageJson === 5) initPuzzle();
        }

        function checkBirthday() {
            const dateInput = birthdateInput;
            const err = document.getElementById('error-msg');
            err.classList.add('hidden');

            if (dateInput.length !== 5 || !dateInput.includes('/')) {
                err.classList.remove('hidden');
                err.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (DD/MM) ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡πä‡∏≤‡∏≤‡∏≤";
                haptic([10, 10, 10]); // Quick buzz buzz buzz
                birthdateInput = "";
                updateBirthdateDisplay();
                return;
            }

            const userMD = dateInput;
            if (userMD === TARGET_BIRTHDAY_MD) { // Uncomment for real use
                //if (true) { // Testing mode: Always allow
                playMusic(); // Plays the default 'bg-music' initially
                goToPage(3);
            } else {
                err.classList.remove('hidden');
                err.innerText = "‡πÄ‡∏≠‡πä‡∏∞! ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ô‡∏™‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏ô‡∏≤";
                haptic([10, 10, 10, 10, 10]);
                birthdateInput = "";
                updateBirthdateDisplay();
            }
        }

        // --- Cake Page Logic ---
        const colorPairs = [
            ['#ff9a9e', '#fecfef'], ['#a18cd1', '#fbc2eb'], ['#84fab0', '#8fd3f4'],
            ['#fccb90', '#d57eeb'], ['#e0c3fc', '#8ec5fc'], ['#ffecd2', '#fcb69f'],
            ['#f6d365', '#fda085'], ['#cfd9df', '#e2ebf0']
        ];
        let availableColors = [...colorPairs];

        function placeCandle(e) {
            if (currentCandles >= totalCandles) return;
            if (isBlowingMode) return;

            // --- NEW: DIM BACKGROUND ON FIRST CANDLE ---
            if (currentCandles === 0) {
                document.body.classList.add('dim-background');
            }

            haptic(5);

            const cakeElement = document.getElementById('new-cake');
            const icingElement = document.getElementById('cake-surface');
            const wishMsg = document.getElementById('wish-message');
            const instruction = document.getElementById('cake-instruction');

            const rect = icingElement.getBoundingClientRect();
            const clickX = e.clientX;
            const clickY = e.clientY;

            const clickedElement = document.elementFromPoint(clickX, clickY);
            if (clickedElement !== icingElement) {
                return;
            }

            const relativeX = clickX - rect.left;
            const relativeY = clickY - rect.top;

            const candle = document.createElement('div');
            candle.className = 'candle';
            candle.id = `candle-${currentCandles}`;

            if (availableColors.length === 0) availableColors = [...colorPairs];
            const randomIndex = Math.floor(Math.random() * availableColors.length);
            const randomPair = availableColors.splice(randomIndex, 1)[0];

            candle.style.setProperty('--c1', randomPair[0]);
            candle.style.setProperty('--c2', randomPair[1]);

            const randomRot = Math.floor(Math.random() * 10) - 5;
            const icingOffsetLeft = parseInt(window.getComputedStyle(icingElement).left) || 0;
            const icingOffsetTop = parseInt(window.getComputedStyle(icingElement).top) || 0;

            candle.style.left = `${relativeX + icingOffsetLeft - 8}px`;
            candle.style.top = `${relativeY + icingOffsetTop - 45}px`;
            candle.style.transform = `translateZ(75px) rotateX(-20deg) rotateZ(${randomRot}deg)`;

            const flame = document.createElement('div');
            flame.className = 'flame';

            // Allow tap to extinguish individual candle
            flame.onclick = (event) => {
                event.stopPropagation();
                if (isBlowingMode) extinguishSingleCandle(candle);
            };
            candle.appendChild(flame);

            cakeElement.appendChild(candle);
            currentCandles++;

            if (currentCandles === totalCandles) {
                wishMsg.style.opacity = '1';
                instruction.style.opacity = '0';
            }
        }

        // --- Wishing & Blowing Logic (MODIFIED) ---

        function finishWishing() {
            const wishText = document.getElementById('wish-text');
            const confirmBtn = document.getElementById('confirm-wish-btn');
            const blowInstruction = document.getElementById('blow-instruction');
            const blowBtn = document.getElementById('blow-btn');

            // Change UI to Blowing Mode
            wishText.textContent = "üéÇ ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πà‡∏≤‡πÄ‡∏Ñ‡πâ‡∏Å‡πÅ‡∏•‡πâ‡∏ß! üéÇ";
            confirmBtn.style.display = 'none';
            blowInstruction.classList.remove('hidden');

            // Show the "Tap to Blow" button instead of Mic instruction
            blowBtn.classList.remove('hidden');

            isBlowingMode = true;
        }

        function triggerCartoonBlow() {
            if (candlesExtinguished >= totalCandles) return;

            const character = document.getElementById('cartoon-blower');
            const svgContainer = character.querySelector('svg');

            // 1. Show Bear
            character.classList.add('active');
            haptic(5);

            // 2. Inhale State (Wait a beat)
            setTimeout(() => {
                // Add inhaling class
                svgContainer.classList.add('inhaling');
            }, 500);

            // 3. Blow State & Extinguish
            setTimeout(() => {
                // Remove inhale, add blowing
                svgContainer.classList.remove('inhaling');
                svgContainer.classList.add('blowing');

                // Play "Whoosh" effect (Wind sound)
                playWindSound();

                // Extinguish candles
                extinguishAllCandles();

                // Hide character after a bit
                setTimeout(() => {
                    character.classList.remove('active');
                    // Reset animations
                    svgContainer.classList.remove('blowing');
                    document.getElementById('blow-btn').style.display = 'none';
                }, 2000);

            }, 1500); // 1.5s total delay (Appear -> Inhale -> Blow)
        }

        function extinguishAllCandles() {
            const candles = document.querySelectorAll('.candle:not(.extinguished)');
            if (candles.length > 0) {
                candles.forEach((candle, index) => {
                    setTimeout(() => {
                        extinguishSingleCandle(candle);
                    }, index * 100 + 300); // Add a little delay to sync with wind animation
                });
            }
        }

        function extinguishSingleCandle(candleElement) {
            if (candleElement.classList.contains('extinguished')) return;

            candleElement.classList.add('extinguished');

            haptic(5);

            const flame = candleElement.querySelector('.flame');
            if (flame) {
                flame.style.opacity = '0';
                setTimeout(() => flame.remove(), 500);

                const smoke = document.createElement('div');
                smoke.className = 'smoke';
                candleElement.appendChild(smoke);

                candlesExtinguished++;

                if (candlesExtinguished >= totalCandles) {
                    allCandlesExtinguished();
                }
            }
        }

        function allCandlesExtinguished() {
            const nextBtn = document.getElementById('next-to-gallery-btn');
            const wishText = document.getElementById('wish-text');
            const blowInstruction = document.getElementById('blow-instruction');

            // --- NEW: LIGHTS ON ---
            document.body.classList.remove('dim-background');

            wishText.textContent = "üéâ ‡πÄ‡∏¢‡πâ! ‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏ô‡∏∞ üéâ";
            blowInstruction.style.display = 'none';

            nextBtn.classList.remove('hidden');
            nextBtn.classList.remove('opacity-0', 'pointer-events-none');

            createConfetti();
            haptic([50, 50, 50]);
        }

        // --- Puzzle Page Logic ---
        function initPuzzle() {
            const board = document.getElementById('puzzle-board');
            board.innerHTML = '';
            board.style.gap = '2px';
            board.style.pointerEvents = 'auto';
            board.style.width = '315px';
            board.style.height = '315px';

            puzzleArr = [0, 1, 2, 3, 4, 5, 6, 7, 8];
            for (let i = puzzleArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [puzzleArr[i], puzzleArr[j]] = [puzzleArr[j], puzzleArr[i]];
            }

            puzzleArr.forEach((val, index) => {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.draggable = true;
                piece.dataset.index = index;
                piece.dataset.correct = val;

                const row = Math.floor(val / 3);
                const col = val % 3;

                piece.style.backgroundImage = `url(${PUZZLE_IMAGE})`;
                piece.style.backgroundPosition = `-${col * 100}px -${row * 100}px`;

                piece.addEventListener('dragstart', handleDragStart);
                piece.addEventListener('dragenter', handleDragEnter);
                piece.addEventListener('dragover', handleDragOver);
                piece.addEventListener('dragleave', handleDragLeave);
                piece.addEventListener('drop', handleDrop);
                piece.addEventListener('dragend', handleDragEnd);

                piece.addEventListener('touchstart', handleTouchStart, { passive: false });
                piece.addEventListener('touchmove', handleTouchMove, { passive: false });
                piece.addEventListener('touchend', handleTouchEnd);

                board.appendChild(piece);
            });
            checkPuzzle();
        }

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('over');
        }

        function handleDragLeave(e) {
            this.classList.remove('over');
        }

        function handleDrop(e) {
            e.stopPropagation();
            if (dragSrcEl !== this) {
                const targetCorrect = this.dataset.correct;
                const targetStyle = this.style.backgroundPosition;

                this.dataset.correct = dragSrcEl.dataset.correct;
                this.style.backgroundPosition = dragSrcEl.style.backgroundPosition;

                dragSrcEl.dataset.correct = targetCorrect;
                dragSrcEl.style.backgroundPosition = targetStyle;

                checkPuzzle();
            }
            return false;
        }

        function handleDragEnd(e) {
            document.querySelectorAll('.puzzle-piece').forEach(piece => {
                piece.classList.remove('over');
                piece.classList.remove('dragging');
            });
            dragSrcEl = null;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            haptic(5);
            touchStartPiece = this;
            touchStartPiece.classList.add('dragging');
            const touch = e.touches[0];
            touchSrc = { x: touch.clientX, y: touch.clientY };
            touchStartPiece.style.zIndex = '100';
            touchStartPiece.style.transform = 'scale(1.1)';
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!touchStartPiece) return;
            const touch = e.touches[0];
            const dx = touch.clientX - touchSrc.x;
            const dy = touch.clientY - touchSrc.y;
            touchStartPiece.style.transform = `translate(${dx}px, ${dy}px) scale(1.1)`;
            touchStartPiece.style.pointerEvents = 'none';
            const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
            touchStartPiece.style.pointerEvents = 'auto';

            if (currentTouchTarget && currentTouchTarget !== touchStartPiece) {
                currentTouchTarget.classList.remove('over');
            }
            if (targetElement && targetElement.classList.contains('puzzle-piece') && targetElement !== touchStartPiece) {
                currentTouchTarget = targetElement;
                currentTouchTarget.classList.add('over');
            } else {
                currentTouchTarget = null;
            }
        }

        function handleTouchEnd(e) {
            if (!touchStartPiece) return;
            haptic(5);
            const dragged = touchStartPiece;
            const target = currentTouchTarget;

            dragged.classList.remove('dragging');
            dragged.style.zIndex = '';
            dragged.style.transform = '';

            if (target) {
                const tempCorrect = target.dataset.correct;
                const tempStyle = target.style.backgroundPosition;

                target.dataset.correct = dragged.dataset.correct;
                target.style.backgroundPosition = dragged.style.backgroundPosition;

                dragged.dataset.correct = tempCorrect;
                dragged.style.backgroundPosition = tempStyle;

                checkPuzzle();
                target.classList.remove('over');
            }

            touchStartPiece = null;
            touchSrc = null;
            currentTouchTarget = null;
        }

        function checkPuzzle() {
            const pieces = document.querySelectorAll('.puzzle-piece');
            const board = document.getElementById('puzzle-board');
            let isSolved = true;

            pieces.forEach((piece, index) => {
                if (parseInt(piece.dataset.correct) !== index) {
                    isSolved = false;
                }
            });

            const successMsg = document.getElementById('puzzle-success');
            const nextBtn = document.getElementById('next-to-card-btn');

            if (isSolved) {
                successMsg.classList.remove('hidden');
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                board.style.gap = '0px';
                board.style.pointerEvents = 'none';
                board.style.width = '310px';
                board.style.height = '310px';
                pieces.forEach(piece => {
                    piece.style.border = 'none';
                    piece.draggable = false;
                    piece.style.pointerEvents = 'none';
                });
                haptic([10, 10, 10, 10, 10]);
                createConfetti();
            } else {
                successMsg.classList.add('hidden');
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
            }
        }

        function createConfetti() {
            (function () {
                if (typeof confetti !== 'undefined') {
                    confetti({ particleCount: 150, spread: 120, origin: { y: 0.6 } });
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js';
                script.onload = () => {
                    confetti({ particleCount: 150, spread: 120, origin: { y: 0.6 } });
                };
                document.head.appendChild(script);
            })();
        }

        function openEnvelope() {
            const envelope = document.getElementById('envelope');
            const tapText = document.getElementById('tapEnvelope');
            if (!envelope.classList.contains('open')) {
                haptic([10, 20]);
                envelope.classList.add('open');
                tapText.style.display = "none";
            }
        }

        console.log("App loaded.");
    </script>
</body>

</html>
